<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script>
var cache = new Reddited.Cache();
var tab_url_map = {};

function get_tab_search_url(tab) {
    var url_map = tab_url_map[tab.id] || {};
    var canonical_url;
    if (url_map.url == tab.url && url_map.canonical_url) {
        canonical_url = Reddited.relative_uri_to_absolute(
            url_map.canonical_url, tab.url);
    }
    return (canonical_url || tab.url);
}

function on_tab_changed(tab) {
    var finder = new Reddited.Finder(cache);
    finder.onRequestSuccess = function(obj) {
        set_badge(tab, obj.num_results);
    };
    finder.request_uri_details(get_tab_search_url(tab));
}

function set_badge(tab, num_results) {
    var color = [0, 230, 0, 255];
    var text = '' + num_results;
    if (num_results == 0) {
        color = [51, 102, 153, 255];
    } else if (num_results > 5) {
        text = '5+';
    }
    chrome.browserAction.setBadgeBackgroundColor(
        {'color': color, 'tabId': tab.id});
    chrome.browserAction.setBadgeText({'text': text, 'tabId': tab.id});
};

chrome.tabs.onUpdated.addListener(function(id, info, tab) {
    if (info.status == "loading") {
        if (tab.url.indexOf("http://") == 0) {
            chrome.tabs.executeScript(tab.id, {"file": "js/content.js"});
        } else {
            on_tab_changed(tab);
        }
    }
});

chrome.tabs.onSelectionChanged.addListener(function() {
    chrome.tabs.getSelected(null, function(tab) {
        if (tab.url.indexOf("http://") == 0) {
            chrome.tabs.executeScript(tab.id, {"file": "js/content.js"});
        } else {
            on_tab_changed(tab);
        }
    });
});

chrome.tabs.onRemoved.addListener(function(id, info) {
    if (tab_url_map[id]) {
        delete tab_url_map[id];
    }
});

chrome.extension.onRequest.addListener(function(request, sender, callback) {
    if (request.action == "log") {
        console.log(request.value);
        callback({});
    } else if (request.action == "content-ready") {
        tab_url_map[sender.tab.id] = {"url": sender.tab.url,
                                      "canonical_url": request.canonical};
        on_tab_changed(sender.tab);
        callback({});
    }
});

    </script>
  </head>
  <body></body>
</html>
