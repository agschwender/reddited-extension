<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script>
var cache = new Reddited.Cache();
var pages = {};

function get_tab_search_uri(tab) {
    if (pages[tab.id] && pages[tab.id].uri == tab.url) {
        return pages[tab.id].get_preferred_uri();
    }
    return tab.url;
};

function on_tab_changed(tab) {
    if (tab.url.indexOf("http://") == 0) {
        chrome.tabs.executeScript(tab.id, {"file": "js/content.js"});
    } else {
        on_tab_ready(tab);
    }
};

function on_tab_ready(tab) {
    var finder = new Reddited.Finder(cache);
    finder.onRequestSuccess = function(obj) {
        set_badge(tab, obj.num_results);
    };
    finder.request_uri_details(get_tab_search_uri(tab));
};

function set_badge(tab, num_results) {
    var color = [0, 230, 0, 255];
    var text = '' + num_results;
    if (num_results == 0) {
        color = [51, 102, 153, 255];
    } else if (num_results > 5) {
        text = '5+';
    }
    chrome.browserAction.setBadgeBackgroundColor(
        {'color': color, 'tabId': tab.id});
    chrome.browserAction.setBadgeText({'text': text, 'tabId': tab.id});
};

chrome.tabs.onUpdated.addListener(function(id, info, tab) {
    if (info.status == "loading") { on_tab_changed(tab); }
});

chrome.tabs.onSelectionChanged.addListener(function() {
    chrome.tabs.getSelected(null, function(tab) { on_tab_changed(tab); });
});

chrome.tabs.onRemoved.addListener(function(id, info) {
    if (pages[id]) { delete pages[id]; }
});

chrome.extension.onRequest.addListener(function(request, sender, callback) {
    if (request.action == "log") {
        console.log(request.value);
        callback({});
    } else if (request.action == "content-ready") {
        pages[sender.tab.id] = new Reddited.Page(
            sender.tab.url, {'canonical_uri': request.canonical});
        on_tab_ready(sender.tab);
        callback({});
    }
});
    </script>
  </head>
  <body></body>
</html>
