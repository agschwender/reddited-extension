<html>
  <head>
    <link rel="stylesheet" href="css/reddit.css" />
    <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script>
      $(document).ready(function() {
          var background_page = chrome.extension.getBackgroundPage();
          var cache = background_page.cache;
          var get_tab_search_uri = background_page.get_tab_search_uri;
          var finder = new Reddited.Finder(cache);

          finder.onRequesting = function() { $('#loader').show(); };
          finder.onRequestError = function(type) {
              $('#loader').hide();
              if (type == Reddited.Finder.REQUEST_ERROR_EMPTY) {
                  return $('#results-none').show();
              } else if (type == Reddited.Finder.REQUEST_ERROR_REDDIT) {
                  return $('#results-reddit').show();
              }
              return $('#results-error').show();
          };

          finder.onRequestSuccess = function(obj) {
              $('#loader').hide();
              if (!obj.num_results) {
                  return $('#results-none').show();
              }

              var siteTable = $('#siteTable', obj.source);
              var results = $(siteTable).children('.thing');

              var re = /<script[^>]+>(\s*(var )?reddit([ =\.]).*?)<\/script>/g;
              var match;
              while (match = re.exec(obj.source)) {
                  $('body').append(
                      '<scr' + 'ipt type="text/javascript">'
                      + match[1]
                      + '</scr' + 'ipt>');
              }

              // include reddit.js after reddit config values have been
              // initialized
              $('body').append(
                  '<scr' + 'ipt type="text/javascript" src="js/reddit.js">'
                  + '</scr' + 'ipt>'
              );

              var e = $('#results');
              $('.content', e).empty();
              $('.view-more', e).hide();
              e.show();
              for (var i = 0; i < Math.min(5, results.length); i++) {
                  $('a', results[i]).attr('target', '_new');
                  $('img', results[i]).each(function() {
                      if ($(this).attr('src') &&
                          $(this).attr('src').indexOf('://') == -1) {
                          $(this).attr('src',
                                       'http://www.reddit.com'
                                       + $(this).attr('src'));
                      }
                  });
                  $(results[i]).appendTo($('.content', e));
                  $('<div class="clearleft" />').appendTo($('.content', e));
              };

              if (results.length > 5) {
                  $('#view-more', e).show();
              }
          };

          chrome.tabs.getSelected(
              null,
              function(tab) {
                  finder.request_uri_details(get_tab_search_uri(tab), true);
                  $('.submit-uri').each(function() {
                      $(this).attr(
                          'href', Reddited.get_reddit_submit_uri(tab.url));
                  });
                  $('#view-more a').attr(
                      'href', Reddited.get_reddit_search_uri(tab.url));


                  $.ajaxPrefilter(function(opts, origopts, jqXHR) {
                      if (opts.url.indexOf('/') == 0) {
                          opts.url = 'http://www.reddit.com' + opts.url;
                      } else if (opts.url.indexOf('://') == -1) {
                          opts.url = 'http://www.reddit.com/' + opts.url;
                      }
                      if (opts.url.indexOf('reddit.com/api') >= 0) {
                          cache.remove(tab.url);
                      }
                  });
              }
          );
      });
    </script>
  </head>
  <body>
    <div id="loader" style="display: none;"><img src="images/loader.gif" /></div>
    <div id="results-none" class="reddited-message" style="display: none;">
      Look at you finding new content. This page has not been submitted to reddit. Maybe you should <a class="submit-uri" href="#" target="_blank">submit it</a> yourself. You know you want to.
      <div class="morelink">
        <a class="submit-uri" href="#" target="_blank">Submit this link</a>
        <div class="nub"></div>
      </div>
    </div>
    <div id="results-error" class="reddited-message" style="display: none;">
      Reddit seems to be having some problems, but, you know, it's reddit so you're probably not that shocked.
    </div>
    <div id="results-reddit" class="reddited-message" style="display: none;">
      I'm gonna go out on a limb and say that since it's on reddit, it's probably already been submitted to reddit.
    </div>
    <div id="results" class="sitetable linklisting" style="display: none;">
      <div class="content"></div>
      <div id="view-more" style="display: none;">
        <p class="nextprev">
          view more: <a href="#" target="_blank">next</a>
        </p>
      </div>
    </div>
  </body>
</html>
