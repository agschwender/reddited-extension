<html>
  <head>
    <link rel="stylesheet" href="css/reddit.css" />
    <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script>
      console.log = function(msg) {
          chrome.extension.sendRequest({'action': 'log', 'value': msg});
      };
      $(document).ready(function() {
          var background_page = chrome.extension.getBackgroundPage();
          var cache = background_page.cache;
          var get_tab_search_uri = background_page.get_tab_search_uri;
          var finder = new Reddited.Finder(cache);

          finder.onRequesting = function() { $('#loader').show(); };
          finder.onRequestError = function(type) {
              $('#loader').hide();
              if (type == Reddited.Finder.REQUEST_ERROR_EMPTY) {
                  return $('#results-none').show();
              } else if (type == Reddited.Finder.REQUEST_ERROR_REDDIT) {
                  return $('#results-reddit').show();
              }
              return $('#results-error').show();
          };

          finder.onRequestSuccess = function(obj) {
              $('#loader').hide();
              if (!obj.count) {
                  return $('#results-none').show();
              }

              var e = $('#results');
              $('.content', e).empty();
              $('.view-more', e).hide();
              e.show();
              for (var i = 0;
                   i < Math.min(Reddited.MAX_RESULTS, obj.results.length);
                   i++) {
                  var r = obj.results[i].data;
                  var t = $('#result-template .thing').clone();
                  $('.rank', t).text(i);
                  $('.score.dislikes', t).text(r.downs);
                  $('.score.unvoted', t).text(r.score);
                  $('.score.likes', t).text(Math.max(0, r.ups - r.downs));
                  $('a.title, a.thumbnail', t).attr('href', r.url);
                  if (r.thumbnail) {
                      $('.thumbnail img', t).attr('src', r.thumbnail);
                  } else {
                      $('.thumbnail', t).hide();
                  }
                  $('a.title', t).text(r.title);
                  $('.domain a')
                  .attr(
                       'href',
                       'http://www.reddit.com/domain/'
                       + encodeURIComponent(r.domain)
                       + '/')
                  .text(r.domain);


                  $('.debug', t).text(JSON.stringify(r));
                  $(t).appendTo($('.content', e));
                  $('<div class="clearleft" />').appendTo($('.content', e));
              };

              if (results.length > 5) {
                  $('#view-more', e).show();
              }
          };

          chrome.tabs.getSelected(
              null,
              function(tab) {
                  finder.request_uri_details(get_tab_search_uri(tab),
                                             {'force': true,
                                              'require_results': true});
                  var f = finder.onRequestSuccess;
                  finder.onRequestSuccess = function(obj) {
                      f(obj);
                      chrome.extension.sendRequest({'action': 'set-badge',
                                                    'count': obj.count,
                                                    'tabId': tab.id});
                  };
                  $('.submit-uri').each(function() {
                      $(this).attr(
                          'href', Reddited.get_reddit_submit_uri(tab.url));
                      $(this).click(function() { cache.remove(tab.url); });
                  });
                  $('#view-more a').attr(
                      'href', Reddited.get_reddit_search_uri(tab.url));


                  $.ajaxPrefilter(function(opts, origopts, jqXHR) {
                      if (opts.url.indexOf('/') == 0) {
                          opts.url = 'http://www.reddit.com' + opts.url;
                      } else if (opts.url.indexOf('://') == -1) {
                          opts.url = 'http://www.reddit.com/' + opts.url;
                      }
                      if (opts.url.indexOf('reddit.com/api') >= 0) {
                          cache.remove(tab.url);
                      }
                  });
              }
          );
      });
    </script>
  </head>
  <body>
    <div id="loader" style="display: none;"><img src="images/loader.gif" /></div>
    <div id="results-none" class="reddited-message" style="display: none;">
      Look at you finding new content. This page has not been submitted to reddit. Maybe you should <a class="submit-uri" href="#" target="_blank">submit it</a> yourself. You know you want to.
      <div class="morelink">
        <a class="submit-uri" href="#" target="_blank">Submit this link</a>
        <div class="nub"></div>
      </div>
    </div>
    <div id="results-error" class="reddited-message" style="display: none;">
      Reddit seems to be having some problems, but, you know, it's reddit so you're probably not that shocked.
    </div>
    <div id="results-reddit" class="reddited-message" style="display: none;">
      I'm gonna go out on a limb and say that since it's on reddit, it's probably already been submitted to reddit.
    </div>
    <div id="results" class="sitetable linklisting" style="display: none;">
      <div class="content"></div>
      <div id="view-more" style="display: none;">
        <p class="nextprev">
          view more: <a href="#" target="_blank">next</a>
        </p>
      </div>
    </div>
    <div id="result-template" style="display: none;">
      <div class=" thing id-t3_ie44o even odd link" onclick="click_thing(this)">
        <div class="debug"></div>
        <p class="parent"></p>
        <span class="rank" style="width:2.20ex;">3</span>
        <div class="midcol unvoted" style="width:5ex;">
          <div class="arrow up" onclick="$(this).vote('1a026347099945eb2d4936e1d403dd74752ba4b3', null, event)"></div>
          <div class="score dislikes">2054</div>
          <div class="score unvoted">2055</div>
          <div class="score likes">2056</div>
          <div class="arrow down" onclick="$(this).vote('1a026347099945eb2d4936e1d403dd74752ba4b3', null, event)"></div>
        </div>
        <a class="thumbnail loggedin " href="http://i.imgur.com/39mgd.png" target="_blank">â€‹<img src="http://thumbs.reddit.com/t3_ie44o.png" alt=""></a>
        <div class="entry unvoted">
          <p class="title">
            <a class="title loggedin  click" href="http://i.imgur.com/39mgd.png" target="_blank">Son, I am not disappoint.</a>
            <span class="domain">(<a href="http://www.reddit.com/domain/i.imgur.com/">i.imgur.com</a>)</span>
          </p>
          <p class="tagline">submitted
            <time title="Fri Jul 1 10:57:09 2011 GMT" datetime="2011-07-01T10:57:09.635212+00:00">8 hours</time> ago by
            <a href="http://www.reddit.com/user/plasticmouse" class="author id-t2_4wtzj">plasticmouse</a>
            <span class="userattrs"></span> to
            <a href="http://www.reddit.com/r/pics/" class="subreddit hover">pics</a>
            <script type="text/javascript">
              // reddit.sr['t3_ie44o'] = 't5_2qh0u';
            </script>
          </p>
          <ul class="flat-list buttons">
            <li class="first">
              <a class="comments" href="http://www.reddit.com/r/pics/comments/ie44o/son_i_am_not_disappoint/" target="_blank">851 comments</a>
            </li>
            <li class="share">
              <span class="share-button toggle" style="">
                <a class="option active " href="#" tabindex="100" onclick="return toggle(this, share, cancelShare)">share</a>
                <a class="option " href="#">cancel</a>
              </span>
            </li>
            <li>
              <form action="/post/save" method="post" class="state-button save-button">
                <input type="hidden" name="executed" value="saved" />
                <span><a href="javascript:void(0)" onclick="return change_state(this, 'save', save_thing);">save</a></span>
              </form>
            </li>
          </ul>
          <div class="expando" style="display: none">
            <span class="error">loading...</span>
          </div>
        </div>
        <div class="child"></div>
        <div class="clearleft"><!--IE6sux--></div>
      </div>
    </div>
  </body>
</html>
