<html>
  <head>
    <link rel="stylesheet" href="css/reddit.css?v=1.3.9" />
    <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
    <script type="text/javascript" src="js/date.js"></script>
    <script type="text/javascript" src="js/main.js?v=1.3.9"></script>
    <script>
      console.log = function(msg) {
          chrome.extension.sendRequest({'action': 'log', 'value': msg});
      };
      $(document).ready(function() {
          var globals = chrome.extension.getBackgroundPage().globals;
          var finder = new Reddited.Finder(globals);

          finder.onRequesting = function() { $('#loader').show(); };
          finder.onRequestError = function(type) {
              $('#loader').hide();
              if (type == Reddited.Finder.REQUEST_ERROR_EMPTY) {
                  return $('#results-none').show();
              } else if (type == Reddited.Finder.REQUEST_ERROR_REDDIT) {
                  return $('#results-reddit').show();
              }
              return $('#results-error').show();
          };

          finder.onRequestSuccess = function(obj) {
              $('#loader').hide();
              if (!obj.count) {
                  return $('#results-none').show();
              }

              var e = $('#results');
              $('.content', e).empty();
              $('.view-more', e).hide();
              e.show();
              for (var i = 0;
                   i < Math.min(Reddited.MAX_RESULTS, obj.results.length);
                   i++) {
                  var r = obj.results[i].data;
                  var t = $('#result-template .thing').clone();
                  $(t).redditResult({'modhash': globals.modhash}, r)
                      .appendTo($('.content', e));
                  $('<div class="clearleft" />').appendTo($('.content', e));
              };

              if (obj.results.length > 5) {
                  $('#view-more', e).show();
              }
          };

          chrome.tabs.getSelected(
              null,
              function(tab) {
                  var url = tab.url;
                  var canonical_urls = [];
                  if (globals.pages[tab.id] &&
                      globals.pages[tab.id].uri == tab.url) {
                      url = globals.pages[tab.id].uri;
                      canonical_urls = globals.pages[tab.id].canonical_uris;
                  }
                  finder.request_uri_details(url,
                                             {'canonical_uris': canonical_urls,
                                              'force': true,
                                              'require_results': true});
                  var f = finder.onRequestSuccess;
                  finder.onRequestSuccess = function(obj) {
                      f(obj);
                      chrome.extension.sendRequest({'action': 'set-badge',
                                                    'count': obj.count,
                                                    'tabId': tab.id});
                  };
                  $('.submit-uri').each(function() {
                      $(this).attr(
                          'href', Reddited.get_reddit_submit_uri(tab.url));
                      $(this).click(function() { cache.remove(url); });
                  });
                  $('#view-more a').attr(
                      'href',
                      Reddited.get_reddit_view_more_uri(url, canonical_urls));

                  $('#action-error a').click(function() {
                      globals.cache.clear();
                      return true;
                  });

                  $.ajaxPrefilter(function(opts, origopts, jqXHR) {
                      if (opts.url.indexOf('reddit.com/api') >= 0) {
                          globals.cache.remove(url);
                      }
                  });
              }
          );
      });
    </script>
  </head>
  <body>
    <div id="loader" style="display: none;"><img src="images/loader.gif" /></div>
    <div id="results-none" class="reddited-message" style="display: none;">
      Look at you finding new content. This page has not been submitted to reddit. Maybe you should <a class="submit-uri" href="#" target="_blank">submit it</a> yourself. You know you want to.
      <div class="morelink">
        <a class="submit-uri" href="#" target="_blank">Submit this link</a>
        <div class="nub"></div>
      </div>
    </div>
    <div id="results-error" class="reddited-message" style="display: none;">
      Reddit seems to be having some problems, but, you know, it's reddit so you're probably not that shocked.
    </div>
    <div id="results-reddit" class="reddited-message" style="display: none;">
      I'm gonna go out on a limb and say that since it's on reddit, it's probably already been submitted to reddit.
    </div>
    <div id="results" class="sitetable linklisting" style="display: none;">
      <div id="action-error">You must <a href="http://www.reddit.com/login" target="_blank">log in</a> to vote or save</div>
      <div class="content"></div>
      <div id="view-more" style="display: none;">
        <p class="nextprev">
          view more: <a href="#" target="_blank">next</a>
        </p>
      </div>
    </div>
    <div id="result-template" style="display: none;">
      <div class="thing link">
        <div class="debug"></div>
        <p class="parent"></p>
        <div class="midcol" style="width:5ex;">
          <div class="arrow up"></div>
          <div class="score dislikes"></div>
          <div class="score unvoted"></div>
          <div class="score likes"></div>
          <div class="arrow down"></div>
        </div>
        <a class="thumbnail" href="#" target="_blank"><img src="#" alt="" /></a>
        <div class="entry unvoted">
          <p class="title">
            <a class="title" href="#" target="_blank"></a>
            <span class="domain">(<a href="#" target="_blank"></a>)</span>
          </p>
          <p class="tagline">submitted
            <time></time> ago by
            <a href="#" class="author" target="_blank"></a>
            <span class="userattrs"></span> to
            <a href="#" class="subreddit hover" target="_blank"></a>
          </p>
          <ul class="flat-list buttons">
            <li class="rounded nsfw-stamp stamp">
              <acronym title="Adult content: Not Safe For Work">NSFW</acronym>
            </li>
            <li class="first">
              <a class="comments" href="#" target="_blank"></a>
            </li>
            <li>
              <span><a class="savable" href="#"></a></span>
            </li>
          </ul>
        </div>
        <div class="child"></div>
        <div class="clearleft"><!--IE6sux--></div>
      </div>
    </div>
  </body>
</html>
